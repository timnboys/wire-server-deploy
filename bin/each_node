#!/usr/bin/env python3

import sys
import json
import subprocess

operation = sys.argv[1]
template = sys.argv[2]
cwd = None
if len(sys.argv) == 4:
    cwd = sys.argv[3]

f = open('~/Wire-Server/kvm-demo-host.json', 'r')
data = json.load(f)
for node in data['hostparams']:
    (nodename, short, cpus, mem, disk, ip, mac, nets) = node
    expansion = eval('f"' + template + '"')
    if operation == 'print':
        print(expansion)
    elif operation == 'run':
        print(expansion)
        completed = subprocess.run(['/bin/bash', '-c', expansion], cwd=cwd)
        if completed.returncode != 0:
            sys.exit(completed.returncode)
    else:
        sys.exit(2)
