# PostgreSQL Configuration for Replica Nodes (Streaming Replication Optimized)
# {{ ansible_managed }}

# Basic Settings
data_directory = '/var/lib/postgresql/{{ postgresql_version }}/main'
hba_file = '/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf'
ident_file = '/etc/postgresql/{{ postgresql_version }}/main/pg_ident.conf'
external_pid_file = '/var/run/postgresql/{{ postgresql_version }}-main.pid'

# Connection Settings
listen_addresses = '*'
port = 5432
superuser_reserved_connections = 3

# Streaming replication configuration
primary_conninfo = 'host={{ primary_node }} port=5432 user={{ repmgr_user }} password={{ repmgr_password }} application_name={{ inventory_hostname }}'
primary_slot_name = '{{ inventory_hostname }}'

# Memory Settings (optimized for 4GB RAM, read workloads)
shared_buffers = 512MB                    # Same as primary for consistency
effective_cache_size = 2GB                # Match primary assumption
work_mem = 8MB                            # Slightly higher for read-heavy workloads
maintenance_work_mem = 64MB               # Match primary
wal_buffers = 8MB                         # Match primary
max_parallel_workers = 2                  # Match core count
max_parallel_workers_per_gather = 1       # Conservative for 2 cores
shared_preload_libraries = 'pg_stat_statements'

# Write-Ahead Logging (WAL) - Replica settings
wal_level = replica                       # Must match primary minimum
wal_keep_size = 500MB                     # Less than primary
max_slot_wal_keep_size = 1GB

# Hot Standby Settings (optimized for resource constraints)
hot_standby = on                          # Enable read queries on replica
max_standby_streaming_delay = 60s         # Longer delay acceptable for resource constraints
max_standby_archive_delay = 60s           # Longer delay acceptable
hot_standby_feedback = on                 # Send feedback to prevent conflicts
wal_receiver_status_interval = 5s         # Less frequent updates to save resources
wal_receiver_timeout = 60s                # Match primary timeout
wal_retrieve_retry_interval = 10s         # Less frequent retries to save resources

# Recovery Settings
restore_command = ''                      # Not using archive recovery
recovery_end_command = ''
recovery_target_timeline = 'latest'      # Always follow the latest timeline

# Checkpoints (less critical on replicas but kept consistent)
checkpoint_completion_target = 0.9
checkpoint_timeout = 5min
max_wal_size = 2GB                        # Match primary
min_wal_size = 256MB                      # Match primary
checkpoint_flush_after = 256kB

# Background Writer (optimized for read workloads)
bgwriter_delay = 50ms                     # Less frequent than primary
bgwriter_lru_maxpages = 500               # Fewer pages than primary
bgwriter_lru_multiplier = 5.0
bgwriter_flush_after = 512kB

# Query Planner (same as primary for consistency)
random_page_cost = 1.5                    # Assume SSD storage
effective_io_concurrency = 200            # SSD can handle more concurrent I/O
maintenance_io_concurrency = 10

# Logging (focused on replication and queries)
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 5000         # Log slower queries on replica
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,client=%h,app=%a '
log_statement = 'none'                    # Less logging on replica
log_replication_commands = on             # Monitor replication
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_recovery_conflict_waits = on          # Log recovery conflicts

# Statistics (focused on read performance)
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Autovacuum (less aggressive on replicas)
autovacuum = on
autovacuum_max_workers = 3                # Fewer workers than primary
autovacuum_naptime = 60s                  # Less frequent than primary
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.2      # Less aggressive than primary
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.1

# Read-only optimizations
default_transaction_isolation = 'read committed'
statement_timeout = 30min                 # Prevent long-running read queries
lock_timeout = 30s                        # Prevent lock waits
idle_in_transaction_session_timeout = 10min

# Locale and Formatting (match primary)
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'
