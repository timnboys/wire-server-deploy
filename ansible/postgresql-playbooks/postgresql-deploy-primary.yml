---
- name: Deploy PostgreSQL Primary node
  hosts: postgresql_rw
  become: yes
  gather_facts: yes
  vars:
    primary_node: "{{ hostvars[(groups.get('postgresql_rw', []) | first) | default('postgresql1')]['ansible_default_ipv4']['address'] | default(hostvars[(groups.get('postgresql_rw', []) | first) | default('postgresql1')]['ansible_host'] | default((groups.get('postgresql_rw', []) | first) | default('postgresql1'))) }}"
    replica_node1: "{{ hostvars[(groups.get('postgresql_ro', []) | first) | default('postgresql2')]['ansible_default_ipv4']['address'] | default(hostvars[(groups.get('postgresql_ro', []) | first) | default('postgresql2')]['ansible_host'] | default((groups.get('postgresql_ro', []) | first) | default('postgresql2'))) }}"
    replica_node2: "{{ hostvars[(groups.get('postgresql_ro', []) | last) | default('postgresql3')]['ansible_default_ipv4']['address'] | default(hostvars[(groups.get('postgresql_ro', []) | last) | default('postgresql3')]['ansible_host'] | default((groups.get('postgresql_ro', []) | last) | default('postgresql3'))) }}"
    pg_service_name: "postgresql@{{ postgresql_version }}-main.service"
  tasks:
    - name: Ensure scripts directory exists
      ansible.builtin.file:
        path: /opt/repmgr/scripts
        state: directory
        owner: postgres
        group: postgres
        mode: "0755"

    - name: Check replication user exists
      community.postgresql.postgresql_query:
        login_db: postgres
        query: "SELECT 1 FROM pg_roles WHERE rolname = '{{ repsvc_user }}'"
      register: repl_user_exists
      become: yes
      become_user: postgres
      ignore_errors: yes

    - name: Check replication slots exist
      community.postgresql.postgresql_query:
        login_db: postgres
        query: "SELECT slot_name FROM pg_replication_slots WHERE slot_name IN ('postgresql2', 'postgresql3')"
      register: existing_slots
      become: yes
      become_user: postgres
      ignore_errors: yes

    - name: Deploy primary configuration files
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: postgres
        group: postgres
        mode: "{{ item.mode }}"
        backup: yes
      loop:
        - src: ../templates/pg_hba.conf.j2
          dest: "{{ postgresql_conf_dir }}/pg_hba.conf"
          mode: "0640"
        - src: ../templates/postgresql_primary.conf.j2
          dest: "{{ postgresql_conf_dir }}/postgresql.conf"
          mode: "0640"
        - src: ../templates/repmgr.conf.j2
          dest: "/etc/repmgr/{{ postgresql_version }}/repmgr.conf"
          mode: "0644"
        - src: ../templates/pgpass.j2
          dest: "/var/lib/postgresql/.pgpass"
          mode: "0600"
        - src: ../templates/simple_fence.sh.j2
          dest: "/opt/repmgr/scripts/simple_fence.sh"
          mode: "0755"
        - src: ../templates/failover_validation.sh.j2
          dest: "/opt/repmgr/scripts/failover_validation.sh"
          mode: "0755"
      register: primary_conf_result

    - name: Ensure instance drop-in directory exists
      ansible.builtin.file:
        path: "/etc/systemd/system/{{ pg_service_name }}.d"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Install guard drop-in (ExecStartPre)
      ansible.builtin.template:
        src: ../templates/guard.conf.j2
        dest: "/etc/systemd/system/{{ pg_service_name }}.d/guard.conf"
        owner: root
        group: root
        mode: "0644"
      register: guard_dropin

    - name: Reload systemd if drop-in changed
      ansible.builtin.command: systemctl daemon-reload
      when: guard_dropin.changed

    - name: Ensure allow-primary-start marker exists on primary

      ansible.builtin.copy:
        dest: "{{ postgresql_data_dir }}/allow-primary-start"
        content: ""
        owner: postgres
        group: postgres
        mode: "0640"
        force: no
      register: allow_primary_file

    - name: restart postgresql primary
      ansible.builtin.service:
        name: "{{ pg_service_name }}"
        state: restarted
      become: yes
      when: primary_conf_result.changed or guard_dropin.changed or (allow_primary_file is defined and allow_primary_file.changed)

    - name: Ensure PostgreSQL instance is running and enabled
      ansible.builtin.service:
        name: "{{ pg_service_name }}"
        state: started
        enabled: yes

    - name: Wait for PostgreSQL to be ready
      ansible.builtin.wait_for:
        port: 5432
        host: "127.0.0.1"
        delay: 5
        timeout: 60

    # ===== PHASE 3: DATABASE SETUP =====

    - name: Setup database users and structures
      block:
        # Legacy replication setup
        - name: Setup legacy replication
          block:
            - name: Create legacy replication user
              community.postgresql.postgresql_user:
                name: "{{ repsvc_user }}"
                password: "{{ repsvc_password }}"
                role_attr_flags: REPLICATION,LOGIN
                login_db: postgres
                state: present
              become_user: postgres

            - name: Create legacy replication slots
              community.postgresql.postgresql_slot:
                name: "{{ item }}"
                slot_type: physical
                state: present
                login_db: postgres
              loop: "{{ replica_nodes }}"
              become_user: postgres

          when: not (repmgr_enabled | default(false))

        # repmgr setup
        - name: Setup repmgr infrastructure
          block:
            - name: Create repmgr user
              community.postgresql.postgresql_user:
                name: "{{ repmgr_user }}"
                password: "{{ repmgr_password }}"
                role_attr_flags: SUPERUSER,REPLICATION
                login_db: postgres
                state: present
              become_user: postgres

            - name: Create repmgr database
              community.postgresql.postgresql_db:
                name: "{{ repmgr_database }}"
                owner: "{{ repmgr_user }}"
                state: present
              become_user: postgres

            - name: Create repmgr extension
              community.postgresql.postgresql_ext:
                name: repmgr
                db: "{{ repmgr_database }}"
                login_host: "127.0.0.1"
                login_user: "{{ repmgr_user }}"
                login_password: "{{ repmgr_password }}"
                state: present
              become_user: postgres

          when: repmgr_enabled | default(false)

    # ===== PHASE 4: REPMGR REGISTRATION =====

    - name: Register primary with repmgr
      block:
        - name: Check current repmgr registration status
          ansible.builtin.command:
            cmd: sudo -u postgres repmgr -f /etc/repmgr/{{ postgresql_version }}/repmgr.conf node status
          register: repmgr_status_check
          failed_when: false
          changed_when: false

        - name: Register primary node
          ansible.builtin.command:
            cmd: sudo -u postgres repmgr -f /etc/repmgr/{{ postgresql_version }}/repmgr.conf primary register
          when: repmgr_status_check.rc != 0
          register: repmgr_registration
          failed_when:
            - repmgr_registration.rc != 0
            - "'already registered' not in repmgr_registration.stderr"

        - name: Display registration status
          ansible.builtin.debug:
            msg: "{{ 'Primary registered successfully' if repmgr_registration.changed else 'Primary already registered' }}"

        - name: Verify repmgr database connectivity before starting daemon
          community.postgresql.postgresql_query:
            login_host: "127.0.0.1"
            login_user: "{{ repmgr_user }}"
            login_password: "{{ repmgr_password }}"
            login_db: "{{ repmgr_database }}"
            query: "SELECT 'connection_test' as status"
          become_user: postgres
          register: repmgr_connection_test

        - name: Start repmgrd service only if connection works
          ansible.builtin.systemd:
            name: "repmgrd@{{ postgresql_version }}"
            state: started
            enabled: yes
            daemon_reload: yes
          when: repmgr_connection_test is succeeded

        - name: Verify repmgrd is running
          ansible.builtin.systemd:
            name: "repmgrd@{{ postgresql_version }}"
          register: repmgrd_status

        - name: Display repmgrd status
          ansible.builtin.debug:
            msg: "repmgrd service: {{ repmgrd_status.status.ActiveState }}"

      when: repmgr_enabled | default(false)
